---
title: "Bisphosphonates network meta-analysis: outcomes other than fever"
author: ""
date: "`r Sys.Date()`"
output:
 html_document:
  code_folding: hide
vignette: >
 %\VignetteIndexEntry{Vignette Title}
 %\VignetteEngine{knitr::rmarkdown}
 \usepackage[utf8]{inputenc}
---

```{r include = FALSE}
knitr::opts_chunk$set(echo=FALSE,
                      fig.width=10,
                      fig.height=7)
```

From literature review, need to include at least the following categories of events

  * vomiting
  * osteonecrosis of the jaw
  * nausea
  * haematological and lymphatic toxicities
  * respiratory problems.
  * gastro-intestinal problems (with oral bisphosphonates in particular)
  * flu-like
  * eye inflammation
  * fatigue
  * dizziness
  * thirst
  * fainting
  * edema, a cold, 
  * insomnia
  * tremors.
  * atrial fibrillation
  * stroke
  * renal dysfunction

and from AZURE analysis, should include the following

  * Myalgia/arthralgia
  * Fever/chills/other flu-like
  * Jaw/dental problems
  * Oedema
  * Abnormal LFTs
  * Neuro-sensory
  * Dry mouth
  * Gastrointestinal
  * Cardiac symptoms
  * Hypocalcaemia
  * Mucositis/stomatitis
  * Dizziness
  * Fainting
  * Arthritis
  * Hypercalcaemia
  * Disturbed renal function

plus any others indicated by the aggregate data extracted from the literature, but unclear what criterion to use to select. 

For the AZURE analysis, selected events were those with either estimated odds ratios > 1.5 or risk differences > 0.01  (not considering p-values) 

Here the aggregate data are explored with a view to selecting a suitable set of events for more detailed analysis. 

Should we select also events with 

Are any events that "look important" from the data excluded by the 1.5/0.01 criterion? 

```{r,message=FALSE}

load_all("..")
library(dplyr)
library(ggplot2)
library(plotly)

```


## Raw data on frequency of each type of event, aggregated over all studies 

Proportions of individuals experiencing each type of event, aggregated over all studies and treatments (including placebo/observation only)

```{r include = FALSE}
knitr::opts_chunk$set(fig.width=10, fig.height=11)
```

```{r,warning=FALSE}

bpplot <- 
  bpaearmtype %>%
  filter(!aetype %in% c("ANY ADVERSE EVENT", "SERIOUS ADVERSE EVENTS")) %>% 
  group_by(aetype) %>%
  summarise(N=sum(N), count=sum(count)) %>%
  mutate(prop = count/N) %>%
  mutate(aetype=factor(aetype, levels=unique(aetype)[order(prop)])) %>%
  mutate(pse = N*prop*(1-prop))

p <- ggplot(bpplot, aes(x=prop, y=aetype, size=count)) + 
geom_point() +
xlab("Proportion having event") +
ylab("")
ggplotly(p)

```


## Simple meta-analysis of bisphosphonate effects on risk for each event type

Including only studies where bisphosphonate compared to a control 

Standard fixed effects meta analysis

```{r,warning=FALSE}

library(meta)

mares <- data.frame(aetype=levels(bpplot$aetype))
mares$totn <- mares$totr <- mares$totncon <- mares$totrcon <-
  mares$or <- mares$orl <- mares$oru <- 
    mares$rd <- mares$rdl <- mares$rdu <- NA

for (i in seq(along.with=mares$aetype)){ 
    bpma <-
      bpaeriskdiff %>%
      filter(trtcon %in% c("100","101","103")) %>%
      filter(aetype==mares$aetype[i])
    if (nrow(bpma) > 0){
    mres <- metabin(count, N, rcon, ncon, studlab=`Trial name`, data=bpma, sm="OR")
    mresrd <- metabin(count, N, rcon, ncon, studlab=`Trial name`, data=bpma, sm="RD")
    mares$totn[i] <- sum(bpma$N) 
    mares$totr[i] <- sum(bpma$count) 
    mares$totncon[i] <- sum(bpma$ncon) 
    mares$totrcon[i] <- sum(bpma$rcon)
    mares[i,c("or","orl","oru")] <- exp(unlist(mres[c("TE.fixed","lower.fixed","upper.fixed")]))
    mares[i,c("rd","rdl","rdu")] <- unlist(mresrd[c("TE.fixed","lower.fixed","upper.fixed")])
    } else
        mares[i,c("totn","totr","totncon","totrcon")] <- 0
}
mares <- mares %>%
  mutate(include = (or > 1.5) | (rd > 0.01)) %>%
  mutate(label = sprintf("\n%s/%s treatment\n%s/%s control\nOR = %s\nRisk difference = %s",                         
                         totr,totn,totrcon,totncon,
                         round(or,3), round(rd,3)))

```

Risk difference and CI, pooled over studies 

Lines coloured red are those with *either* estimated odds ratio > 1.5 or risk difference > 0.01 

```{r,warning=FALSE}
p <- mares %>%
  mutate(aetype = factor(mares$aetype, levels=mares$aetype[order(mares$rd)])) %>%  
  filter(!is.na(rd)) %>% 
  ggplot(aes(y=rd, x=aetype, col=include, label=label)) + 
  coord_flip(ylim=c(-0.1, 0.1)) +
  geom_hline(aes(yintercept=0), col="gray") + 
  geom_point(aes(size=totr), position=position_dodge(-0.4)) +
  geom_errorbar(aes(ymin=rdl, ymax=rdu),
                width=0, position=position_dodge(-0.4)) +
  scale_y_continuous(breaks = c(-0.10, seq(-0.05, 0.05, by=0.01), 0.1)) + 
  ylab("Risk (bisphosphonates) - risk (control)") +
  xlab("") + 
  scale_colour_manual(values=c("black","red")) +
  theme(legend.position = "none")
ggplotly(p, tooltip="label")
```


Odds ratio and CI, pooled over studies 

Lines coloured red are those with *either* estimated odds ratio > 1.5 or risk difference > 0.01 

```{r,warning=FALSE}
p <- mares %>%
  mutate(aetype = factor(mares$aetype, levels=mares$aetype[order(mares$or)])) %>% 
  filter(!is.na(or)) %>% 
  ggplot(aes(y=or, x=aetype, col=include, label=label)) + 
  coord_flip(ylim=c(0.1, 10)) +
  geom_hline(aes(yintercept=1), col="gray") + 
  geom_point(aes(size=totr), position=position_dodge(-0.4)) +
  geom_errorbar(aes(ymin=orl, ymax=oru),
                width=0, position=position_dodge(-0.4)) +
  scale_y_continuous(trans="log", 
                     breaks=c(0.1, 0.2, 0.5, 1, 2, 5, 10)) +
  ylab("Odds ratio (bisphosphonates / control)") +
  xlab("") +
  scale_colour_manual(values=c("black","red")) +
  theme(legend.position = "none")
ggplotly(p, tooltip="label")
```
