---
title: "Bisphosphonates standard direct-data meta-analysis: all outcomes"
author: ""
date: "`r Sys.Date()`"
output:
 html_document:
  code_folding: hide
vignette: >
 %\VignetteIndexEntry{Vignette Title}
 %\VignetteEngine{knitr::rmarkdown}
 \usepackage[utf8]{inputenc}
---

```{r,message=FALSE}

load_all("../../gemtc/gemtc")
load_all("..")
library(dplyr)
filter <- dplyr::filter
library(ggplot2)
library(plotly)
source("theme.r")

```


## Raw data on frequency of each type of event, aggregated over all studies 

Proportions of individuals experiencing each type of event, aggregated over all studies and treatments (including placebo/observation only)

```{r include = FALSE}
knitr::opts_chunk$set(fig.width=15, fig.height=20)
```

```{r,warning=FALSE}

aecount <- 
  bpaearmtype %>%
  filter(!aetype %in% c("ANY ADVERSE EVENT", "SERIOUS ADVERSE EVENTS")) %>% 
  group_by(aetype) %>%
  summarise(N=sum(N), count=sum(count)) %>%
  mutate(prop = count/N) %>%
  mutate(aetype=factor(aetype, levels=unique(aetype)[order(prop)])) %>%
  mutate(pse = N*prop*(1-prop))

p <- ggplot(aecount, aes(x=prop, y=aetype, size=count)) + 
  geom_point() +
  xlab("Proportion having event") +
  ylab("") +
  paper_theme
# ggplotly(p)

```

## Comparison of heterogeneity in odds ratio and risk difference. or baseline risk? 

```{r}

bpplot <- bpaeriskdiff %>%
    mutate(
        oddsact = ((count+0.5)/(N+1)) / (1 - (count+0.5)/(N+1)),
        oddscon = ((rcon+0.5)/(ncon+1)) / (1 - (rcon+0.5)/(ncon+1)),
        est = oddsact / oddscon,
        selogor = sqrt(1/(rcon+0.5) + 1/(ncon-rcon+0.5) + 1/(count+0.5) + 1/(N-count+0.5)),
        or = est, 
        orlower = exp(log(est) - qnorm(0.975)*selogor),
        orupper = exp(log(est) + qnorm(0.975)*selogor),
        a = count, b=N-count, c=rcon, d=ncon-rcon,
        serd = sqrt(a*b/(a+b)^3 + c*d/(c+d)^3),
        rdlower = riskdiff - qnorm(0.975)*serd,
        rdupper = riskdiff + qnorm(0.975)*serd,
        brisk = rcon / ncon, 
        brisklower = qbeta(0.025, 0.5 + rcon, 0.5 + ncon - rcon),
        briskupper = qbeta(0.975, 0.5 + rcon, 0.5 + ncon - rcon)
    ) %>%
  filter(aetype=="FEVER") %>%
    select(study, or, orlower, orupper, riskdiff, rdlower, rdupper, brisk, brisklower, briskupper, count, N, rcon, ncon)

orres <- metabin(count, N, rcon, ncon, studlab=study, data=bpplot, sm="OR")
rdres <- metabin(count, N, rcon, ncon, studlab=study, data=bpplot, sm="RD")
orres <- as.data.frame(lapply(orres[c("TE.fixed","lower.fixed","upper.fixed")], exp))
names(orres) <- c("or", "orlower", "orupper")
rdres <- as.data.frame(rdres[c("TE.fixed","lower.fixed","upper.fixed")])
names(rdres) <- c("riskdiff", "rdlower", "rdupper")
orres$study <- rdres$study <- "Pooled estimate"

psize <- 3
lsize <- 1.5
wsize <- 0.2
p1 <- ggplot(bpplot, aes(x=study, y=or)) +
  coord_flip(ylim=c(0.2, 20)) +
  geom_hline(yintercept=1, col="gray") + 
  geom_point(size=psize) +
  geom_errorbar(aes(ymin = orlower, ymax = orupper), size=lsize, width=wsize) +
  scale_y_continuous(trans="log", breaks=c(0.2, 0.5, 1, 2, 5, 10, 20)) + 
  geom_point(data=orres, aes(y=or, x=0), col="red") +
  geom_errorbar(data=orres, aes(ymin = orlower, ymax = orupper, x=0), col="red",  width=2*wsize, size=lsize) +
  geom_text(aes(x=0, y=1), hjust=1, label="Pooled estimate", col="red") + 
  paper_theme + 
  ylab("Odds ratio") + xlab("")

p2 <- ggplot(bpplot, aes(x=study, y=riskdiff)) +
  coord_flip() + 
  geom_hline(yintercept=0, col="gray") + 
  geom_point(size=psize) +
  geom_errorbar(aes(ymin = rdlower, ymax = rdupper), size=lsize, width=wsize) +
  geom_point(data=rdres, aes(y=riskdiff, x=0), col="red") +
  geom_errorbar(data=rdres, aes(ymin = rdlower, ymax = rdupper, x=0),
                col="red",  width=2*wsize, size=lsize) +
  geom_text(aes(x=0, y=0), hjust=1, label="Pooled estimate", col="red") + 
  ylab("Risk difference") + xlab("") +
  paper_theme + 
  theme(axis.text.y = element_blank())
p2

p3 <- ggplot(bpplot, aes(x=study, y=brisk)) +
    coord_flip() + 
    geom_point(size=psize) +
    geom_errorbar(aes(ymin = brisklower, ymax = briskupper), size=lsize, width=wsize) +
    ylab("Proportion of controls having event") + xlab("") + 
    paper_theme + 
    theme(axis.text.y = element_blank())

gridExtra::grid.arrange(p1, p2, p3, ncol=3, widths=c(3,2,2))


```


## Simple meta-analysis of bisphosphonate effects on risk for each event type

Including only studies where bisphosphonate compared to a control 

Standard fixed effects meta analysis

```{r,warning=FALSE}

library(meta)

mares <- data.frame(aetype=levels(aecount$aetype))
mares$totn <- mares$totr <- mares$totncon <- mares$totrcon <-
  mares$or <- mares$orl <- mares$oru <- 
    mares$rd <- mares$rdl <- mares$rdu <- NA

for (i in seq(along.with=mares$aetype)){ 
    bpma <-
      bpaeriskdiff %>%
      filter(trtcon %in% c("100","101","103")) %>%
      filter(aetype==mares$aetype[i])
    if (nrow(bpma) > 0){
    mres <- metabin(count, N, rcon, ncon, studlab=study, data=bpma, sm="OR")
    mresrd <- metabin(count, N, rcon, ncon, studlab=study, data=bpma, sm="RD")
    mares$totn[i] <- sum(bpma$N) 
    mares$totr[i] <- sum(bpma$count) 
    mares$totncon[i] <- sum(bpma$ncon) 
    mares$totrcon[i] <- sum(bpma$rcon)
    mares[i,c("or","orl","oru")] <- exp(unlist(mres[c("TE.fixed","lower.fixed","upper.fixed")]))
    mares[i,c("rd","rdl","rdu")] <- unlist(mresrd[c("TE.fixed","lower.fixed","upper.fixed")])
    } else
        mares[i,c("totn","totr","totncon","totrcon")] <- 0
}
mares <- mares %>%
  mutate(sig = (or > 1.5) | (rd > 0.02)) %>%
  mutate(label = sprintf("\n%s/%s treatment\n%s/%s control\nOR = %s\nRisk difference = %s",                         
                         totr,totn,totrcon,totncon,
                         round(or,3), round(rd,3)))

```


```{r,warning=FALSE}

cres <- aecount %>% select(aetype, prop, count) %>% rename(est=prop) %>% mutate(measure="Proportion having event")
rdres <- mares %>% select(aetype, rd, rdl, rdu) %>% rename(est=rd, lower=rdl, upper=rdu) %>% mutate(measure="Risk difference (vs control)")
orres <- mares %>% select(aetype, or, orl, oru) %>% rename(est=or, lower=orl, upper=oru) %>% mutate(measure="Odds ratio (bisphosphonates / control)")

directplot <- cres %>%
  full_join(rdres) %>% full_join(orres)

p0 <- directplot %>%
  filter(measure=="Proportion having event") %>% 
  mutate(aetype = factor(.data$aetype, levels=cres$aetype[order(cres$est)])) %>%
  ggplot(aes(y=est, x=aetype)) +
  coord_flip() + 
  geom_point(position=position_dodge(-0.4)) +
  geom_errorbar(aes(ymin=lower, ymax=upper),
                position=position_dodge(-0.4)) +
  scale_x_discrete(drop=FALSE) + 
  scale_y_continuous(breaks = seq(0, 0.3, by=0.05)) + 
  scale_colour_manual(values=c("black","red")) +
  theme(legend.position = "none",
        axis.text.y = element_blank()) +
  ggtitle("Proportion having event") + 
  paper_theme + 
  ylab("") + xlab("") 

levs <- cres$aetype[order(cres$est)]
p1dat <- directplot %>%
  filter(measure=="Risk difference (vs control)") %>% 
  mutate(aetype = factor(.data$aetype, levels=levs)) %>%
  mutate(sig = (est > 0.02 & lower > 0)) %>%
  filter(!is.na(est))
levels(p1dat$aetype) <- sprintf("%s (%s)", levels(p1dat$aetype), round(cres$est[order(cres$est)],2))

p2dat <- directplot %>%
  filter(measure=="Odds ratio (bisphosphonates / control)") %>% 
  mutate(aetype = factor(.data$aetype, levels=levs)) %>%  
  mutate(sig = (est > 1.5 & lower > 1)) %>% 
  filter(!is.na(est))
levels(p2dat$aetype) <- sprintf("%s (%s)", levels(p2dat$aetype), round(cres$est[order(cres$est)],2))

sigcol <- rep("black", length(levels(p1dat$aetype)))
sigcol[match(as.character(p1dat$aetype), levels(p1dat$aetype))] <- ifelse(p1dat$sig | p2dat$sig, "red","black")

p1 <- p1dat %>% 
  ggplot(aes(y=est, x=aetype, color=sig)) +
  coord_flip(ylim=c(-0.1, 0.2)) + 
  scale_x_discrete(drop=FALSE) +
  geom_hline(yintercept=0.0, col="gray") + 
  scale_y_continuous(breaks = seq(-0.1, 0.2, by=0.05)) + 
  geom_point(position=position_dodge(-0.4)) +
  geom_errorbar(aes(ymin=lower, ymax=upper),
                position=position_dodge(-0.4)) +
  scale_colour_manual(values=c("black","red")) +
  theme(legend.position = "none",
        axis.text.y = element_text(colour=sigcol),
        plot.title = element_text(hjust = 0)) +
  ggtitle("Risk difference (vs control)") + 
  paper_theme + 
  ylab("") + xlab("") 

p2 <- p2dat %>% 
  ggplot(aes(y=est, x=aetype, color=sig)) +
  coord_flip(ylim=c(0.2, 20)) + 
  scale_x_discrete(drop=FALSE) + 
  scale_y_continuous(trans="log",
                     breaks=c(0.2, 0.5, 1, 2, 5, 10, 20)) +
  geom_hline(yintercept=1.0, col="gray") + 
  geom_point(position=position_dodge(-0.4)) +
  geom_errorbar(aes(ymin=lower, ymax=upper),
                position=position_dodge(-0.4)) +
  scale_colour_manual(values=c("black","red")) +
  theme(legend.position = "none",
        axis.text.y = element_blank(),
        plot.title = element_text(hjust = 0)) + 
  ggtitle("Odds ratio (bisphosphonates / control)") + 
  paper_theme + 
  ylab("") + xlab("") 

library(gridExtra)
grid.arrange(p1, p2, ncol=2, widths=c(3,2))

#png("direct.png")
#grid.arrange(p0, p1, p2, ncol=3, widths=c(2,3,3))
#dev.off() 

```
