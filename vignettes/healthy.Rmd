---
title: "Bisphosphonates adverse events meta-analysis: comparing healthy and cancer patients"
author: ""
date: "`r Sys.Date()`"
output:
 html_document:
  code_folding: hide
vignette: >
 %\VignetteIndexEntry{Vignette Title}
 %\VignetteEngine{knitr::rmarkdown}
 \usepackage[utf8]{inputenc}
---

# Bisphosphonate effects on events compared between cancer and healthy patients. 

Just two studies of bisphosphonates for preventing osteoperosis in "healthy" women without cancer: FIT and Horizon.

* HORIZON: two papers reported on the same population, one reporting acute events following the start of treatment, and one with longer follow-up.   It's unclear whether some of the same events are repeated between the two reports. 

* FIT: two papers, one reporting the full trial population and the other reporting a subgroup.  The only events reported were abdominal pain, oesophagitis, dyspepsia, gastrointestinal (unspecified) and nausea.  

```{r,echo=FALSE,message=FALSE,warning=FALSE}
knitr::opts_chunk$set(echo=FALSE,
                      message=FALSE,
                      fig.width=15,
                      fig.height=15)

library(flextable)
library(meta)
library(plotly)
library(binom) 
library(dplyr) 
load_all("..")

hae <- unique(bpaeprevma$aetype) 
bpaeprevma$patient <- "Healthy"
bpcma <-
  bpaeriskdiff %>%
  filter(trtcon %in% c("100","101","103")) %>%
  filter(aetype %in% hae) %>%
  rename(ract=count, nact=N) %>% 
  mutate(patient = "Cancer") %>% 
  select(names(bpaeprevma)) %>% 
  rbind(bpaeprevma) %>%
  arrange(patient, `Trial name`, aetype) %>%
  mutate(p0 = (rcon+0.5)/(ncon+1),
         p1 = (ract+0.5)/(nact+1),
         or = p1/(1-p1) / (p0/(1-p0)),
         logor = log(or), 
         selogor = sqrt(1/(rcon+0.5) + 1/(ncon-rcon+0.5) +
                        1/(ract+0.5) + 1/(nact-ract+0.5)),
         orl = exp(log(or) - qnorm(0.975)*selogor),
         oru = exp(log(or) + qnorm(0.975)*selogor)) %>%
  mutate(`Events` = sprintf("\nTreatment %s/%s\nControl %s/%s",
                          ract, nact, rcon, ncon))

```

The table below compares the odds ratios from the network meta-analysis of bisphosphonates in women with cancer with the equivalent odds ratios from a simple meta-analysis of HORIZON and FIT, for the events that are significant in the cancer analysis and also reported in HORIZON and FIT. 

```{r,warning=FALSE,message=FALSE}

eventsh <- bpaeprevma %>% filter(rcon>0|ract>0) %>% select(aetype) %>% unlist %>% as.vector %>% unique
mares <- data.frame(event=eventsh)
mares$or <- mares$orl <- mares$oru <- NA

for (i in seq(along=eventsh)){ 
    bpma <- bpaeprevma %>% filter(aetype==eventsh[i])
    if (nrow(bpma) > 0){
        mres <- metabin(ract, nact, rcon, ncon, studlab=`Trial name`, data=bpma, sm="OR")
        mares[i,c("or","orl","oru")] <- exp(unlist(mres[c("TE.fixed","lower.fixed","upper.fixed")]))
    }
}
mares <- mares %>%
  mutate(orhealthy = sprintf("%s (%s, %s)", round(or,2), round(orl,2), round(oru,2))) %>%
  mutate(treatmenth = "Bisphosphonate") %>%
  select(event, orhealthy, treatmenth)

load("ors.rda")

orsh <- ortab %>% filter(sig) %>% select(categ, event, actlab, NMA) %>%
  left_join(mares, by="event") %>% filter(!is.na(orhealthy)) %>% 
  as_tibble %>%
  select(categ, event, actlab, NMA, treatmenth, orhealthy) %>%
  as_grouped_data(groups="categ") %>%
  flextable %>% 
  set_header_labels(categ="", event="",
                    actlab="Treatment (cancer NMA)",
                    NMA="OR (Cancer, NMA)",
                    treatmenth="Treatment (healthy MA)",
                    orhealthy="OR (healthy MA)"
                    ) %>% 
  flextable::bold(j = 1, i = ~ !is.na(categ), bold = TRUE, part = "body" ) %>%
  flextable::bold(part = "header", bold = TRUE )
orsh


```

The study-specific odds ratios underlying these results are shown below.  

For each event, the odds ratios from HORIZON and FIT are not surprising given the variability between studies.

```{r}

p <- bpcma %>%
  filter(aetype %in% unique(ortab$event[ortab$sig])) %>% 
ggplot(aes(y=or, x=`Trial name`, col=patient, label=Events)) +
                                        #  coord_flip(ylim=c(0.1, 15)) +
  coord_flip(ylim=c(0.1, 20)) +
  geom_hline(yintercept = 1, col="gray") + 
  geom_point() +
  geom_errorbar(aes(ymin = orl, ymax = oru), width=0) +
  facet_wrap(~ aetype, ncol=3) + 
  scale_y_continuous(trans="log", 
                     breaks=c(0.1, 0.2, 0.5, 1, 2, 5, 10, 20)) +
  ylab("Odds ratio (bisphosphonates / control)") +
  xlab("") +
  scale_colour_manual(values=c("black","red")) 
ggplotly(p, tooltip=c("label"), height=5000)

```
