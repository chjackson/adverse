---
title: "Bisphosphonates adverse events meta-analysis: comparing healthy and cancer patients"
author: ""
date: "`r Sys.Date()`"
output:
 html_document:
  code_folding: hide
vignette: >
 %\VignetteIndexEntry{Vignette Title}
 %\VignetteEngine{knitr::rmarkdown}
 \usepackage[utf8]{inputenc}
---

# Bisphosphonate effects on events compared between cancer and healthy patients. 

Just two studies of bisphosphonates for preventing osteoperosis in "healthy" women without cancer: FIT and Horizon.

* HORIZON: two papers reported on the same population, one reporting acute events following the start of treatment, and one with longer follow-up.   It's unclear whether some of the same events are repeated between the two reports. 

* FIT: two papers, one reporting the full trial population and the other reporting a subgroup.  The only events reported were abdominal pain, oesophagitis, dyspepsia, gastrointestinal (unspecified) and nausea.  

```{r,echo=FALSE,message=FALSE,warning=FALSE}
knitr::opts_chunk$set(echo=FALSE,
                      message=FALSE,
                      fig.width=15,
                      fig.height=15)

library(meta)
library(plotly)
library(binom) 
load_all("..")

hae <- unique(bpaeprevma$aetype) 
bpaeprevma$patient <- "Healthy"
bpcma <-
  bpaeriskdiff %>%
  filter(trtcon %in% c("100","101","103")) %>%
  filter(aetype %in% hae) %>%
  rename(ract=count, nact=N) %>% 
  mutate(patient = "Cancer") %>% 
  select(names(bpaeprevma)) %>% 
  rbind(bpaeprevma) %>%
  arrange(patient, `Trial name`, aetype) %>%
  mutate(p0 = (rcon+0.5)/(ncon+1),
         p1 = (ract+0.5)/(nact+1),
         or = p1/(1-p1) / (p0/(1-p0)),
         logor = log(or), 
         selogor = sqrt(1/(rcon+0.5) + 1/(ncon-rcon+0.5) +
                        1/(ract+0.5) + 1/(nact-ract+0.5)),
         orl = exp(log(or) - qnorm(0.975)*selogor),
         oru = exp(log(or) + qnorm(0.975)*selogor)) %>%
  mutate(`Events` = sprintf("\nTreatment %s/%s\nControl %s/%s",
                          ract, nact, rcon, ncon))

```


For all event types where there is data from both women with and without cancer, the estimated odds ratios, from all available studies comparing a bisphosphonate with a placebo or observation-only control, are plotted.

Osteonecrosis of the jaw is excluded due to very small counts: in HORIZON there was one case in the control group and one in the treatment group.   Note also in the OPTIMIZE2 study there were two bisphosphonate arms and one control arms, therefore two comparisons are presented for this study. 

For each event, the odds ratios from the HORIZON studies are consistent with the other studies, though there is a lot of variability between studies.

```{r}

selected_events  <- c("ARTHRALGIA/JOINT PAIN", "CARDIAC EVENTS", "CHILLS", "FEVER", "FATIGUE", "HEADACHE", "DIARRHOEA", "MYALGIA", "Influenza-like symptoms")

#bpcma %>%
#  filter(aetype %in% selected_events) %>%
#  filter(!(`Trial name` %in% c("FIT","FIT_sub"))) %>%  
#  select(rcon, ncon, ract, nact, or, selogor, orl, oru) 

p <- bpcma %>% # filter(aetype %in% selected_events) %>%  filter(!(`Trial name` %in% c("FIT","FIT_sub"))) %>%  
ggplot(aes(y=or, x=`Trial name`, col=patient, label=Events)) +
                                        #  coord_flip(ylim=c(0.1, 15)) +
  coord_flip(ylim=c(0.1, 20)) +
  geom_hline(yintercept = 1, col="gray") + 
  geom_point() +
  geom_errorbar(aes(ymin = orl, ymax = oru), width=0) +
  facet_wrap(~ aetype, ncol=3) + 
  scale_y_continuous(trans="log", 
                     breaks=c(0.1, 0.2, 0.5, 1, 2, 5, 10, 20)) +
  ylab("Odds ratio (bisphosphonates / control)") +
  xlab("") +
  scale_colour_manual(values=c("black","red")) 
ggplotly(p, tooltip=c("label"), height=5000)

```

